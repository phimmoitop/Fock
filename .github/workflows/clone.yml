name: M3U8 to Repo

on:
  workflow_dispatch:
    inputs:
      link:
        description: "Link m3u8"
        required: true
      slug:
        description: "Slug"
        required: true
      account:
        description: "GitHub account"
        required: true
      token:
        description: "GitHub token"
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # Checkout
      # =======================
      - name: Checkout repository
        uses: actions/checkout@v3

      # =======================
      # Setup FFmpeg
      # =======================
      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v2

      # =======================
      # Install tools
      # =======================
      - name: Install system tools
        run: |
          sudo apt update
          sudo apt install -y curl git jq

      # =======================
      # b1: Create private repo (idempotent)
      # =======================
      - name: Create private repository (if not exists)
        run: |
          OWNER="${{ inputs.account }}"
          REPO="${{ inputs.slug }}"
          TOKEN="${{ inputs.token }}"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $TOKEN" \
            https://api.github.com/repos/$OWNER/$REPO)

          if [ "$STATUS" = "200" ]; then
            echo "Repo already exists, skip creation"
            exit 0
          fi

          RESPONSE=$(curl -s -X POST https://api.github.com/user/repos \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{
              \"name\": \"$REPO\",
              \"private\": true
            }")

          echo "$RESPONSE" | jq -e '.id' > /dev/null || {
            echo "Create repo failed"
            echo "$RESPONSE"
            exit 1
          }

      # =======================
      # b2: Download m3u8 â†’ mp4 (SAFE)
      # ===
