name: Debug m3u8 to mp4

on:
  workflow_dispatch:

jobs:
  test-m3u8:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # 1. Install ffmpeg (APT)
      # =======================
      - name: Install ffmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl
          ffmpeg -version

      # =======================
      # 2. Environment debug
      # =======================
      - name: Environment debug
        run: |
          echo "CPU:"
          nproc
          echo "ULIMIT:"
          ulimit -a
          echo "Network test:"
          curl -I https://789327668233050.scontent-x22-fbcdn.pages.dev/789327668233050.m3u8

      # =======================
      # 3. Download m3u8 â†’ mp4 (DEBUG MODE)
      # =======================
      - name: Download m3u8 to mp4 (debug)
        run: |
          ffmpeg -y \
            -loglevel debug \
            -stats \
            -threads 1 \
            -i "https://789327668233050.scontent-x22-fbcdn.pages.dev/789327668233050.m3u8" \
            -c copy \
            -bsf:a aac_adtstoasc \
            789327668233050.mp4

      # =======================
      # 4. Check file exists & size
      # =======================
      - name: Check output file
        run: |
          if [ ! -f "789327668233050.mp4" ]; then
            echo "MP4 NOT CREATED"
            exit 1
          fi

          echo "File size:"
          ls -lh 789327668233050.mp4
          stat 789327668233050.mp4

      # =======================
      # 5. ffprobe full debug
      # =======================
      - name: ffprobe video info
        run: |
          ffprobe -v error \
            -show_format \
            -show_streams \
            789327668233050.mp4
